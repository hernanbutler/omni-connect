<!-- Segmentation Section - CON IA -->
<section id="segmentation" class="content-section">
    <header class="section-header">
        <div>
            <h1>Segmentaci√≥n Inteligente</h1>
            <p class="subtitle">An√°lisis RFM + Machine Learning + ChatGPT</p>
        </div>
        <button class="btn btn-primary">
            <i class='bx bx-plus'></i>
            Crear Segmento
        </button>
    </header>

    <!-- Segmentation Overview KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon blue">
                <i class='bx bx-group'></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Total Clientes</span>
                <h2 class="kpi-value" id="kpi-total-clientes">-</h2>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon purple">
                <i class='bx bx-shape-circle'></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Segmentos Activos</span>
                <h2 class="kpi-value" id="kpi-segmentos-activos">-</h2>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon green">
                <i class='bx bx-dollar-circle'></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">CLV Promedio</span>
                <h2 class="kpi-value" id="kpi-clv-promedio">-</h2>
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon orange">
                <i class='bx bx-bot'></i>
            </div>
            <div class="kpi-content">
                <span class="kpi-label">Clusters ML</span>
                <h2 class="kpi-value" id="kpi-segmentos-ia">-</h2>
                <span class="u-muted" style="font-size: 0.75rem;">K-Means</span>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid u-mb-1-5">
        <div class="chart-card">
            <h3>Distribuci√≥n de Segmentos</h3>
            <canvas id="segmentDistributionChart"></canvas>
        </div>
        <div class="chart-card">
            <h3>CLV Total por Segmento</h3>
            <canvas id="clvBySegmentChart"></canvas>
        </div>
    </div>

    <!-- Existing Segments -->
    <h3 class="u-mb-1-5">Segmentos Existentes</h3>
    <div class="segments-grid">
        <!-- VIP Champions -->
        <div class="segment-card" style="border-left: 4px solid var(--success);">
            <div class="segment-header">
                <h4>üèÜ VIP Champions</h4>
                <span class="segment-badge" id="vip-usuarios">- usuarios</span>
            </div>
            <p>Clientes de alto valor con compras frecuentes y engagement excepcional.</p>
            <div class="segment-stats u-grid-1-1 u-mt-1">
                <span><i class='bx bx-dollar'></i> CLV: <strong id="vip-clv">-</strong></span>
                <span><i class='bx bx-trending-up'></i> Engagement: <strong id="vip-engagement">-</strong>%</span>
            </div>
            <button class="btn btn-secondary u-full-width u-mt-1" onclick="generateAIInsights('compradores_vip')">
                <i class='bx bxs-magic-wand'></i> Generar Insights con IA
            </button>
        </div>

        <!-- En Riesgo de Churn -->
    <div class="segment-card" style="border-left: 4px solid var(--danger);">
            <div class="segment-header">
                <h4>‚ö†Ô∏è En Riesgo de Churn</h4>
                <span class="segment-badge warning" id="churn-usuarios">- usuarios</span>
            </div>
            <p>Alta probabilidad de abandono. Acci√≥n inmediata requerida.</p>
            <div class="segment-stats u-grid-1-1 u-mt-1">
                <span><i class='bx bx-error'></i> CLV en Riesgo: <strong id="churn-clv-perdido">-</strong></span>
                <span><i class='bx bx-trending-down'></i> Riesgo: <strong id="churn-riesgo">-</strong>%</span>
            </div>
            <button class="btn btn-secondary u-full-width u-mt-1" onclick="generateAIInsights('en_riesgo_churn')">
                <i class='bx bxs-magic-wand'></i> Generar Insights con IA
            </button>
        </div>

        <!-- Promesa (Alto Potencial) -->
        <div class="segment-card" style="border-left: 4px solid var(--primary);">
            <div class="segment-header">
                <h4>‚≠ê Promesa</h4>
                <span class="segment-badge success" id="promesa-usuarios">- usuarios</span>
            </div>
            <p>Nuevos clientes con alto potencial de crecimiento.</p>
            <div class="segment-stats u-grid-1-1 u-mt-1">
                <span><i class='bx bx-line-chart'></i> Engagement: <strong id="promesa-engagement">-</strong>%</span>
                <span><i class='bx bx-dollar'></i> Potencial: <strong id="promesa-potencial">-</strong></span>
            </div>
            <button class="btn btn-secondary u-full-width u-mt-1" onclick="generateAIInsights('promesa')">
                <i class='bx bxs-magic-wand'></i> Generar Insights con IA
            </button>
        </div>

        <!-- Leales -->
        <div class="segment-card" style="border-left: 4px solid #10b981;">
            <div class="segment-header">
                <h4>üíö Leales</h4>
                <span class="segment-badge" id="leales-usuarios">- usuarios</span>
            </div>
            <p>Clientes regulares con buen engagement y compras consistentes.</p>
            <div class="segment-stats u-grid-1-1 u-mt-1">
                <span><i class='bx bx-dollar'></i> CLV: <strong id="leales-clv">-</strong></span>
                <span><i class='bx bx-cart'></i> Compras: <strong id="leales-compras">-</strong></span>
            </div>
            <button class="btn btn-secondary u-full-width u-mt-1" onclick="generateAIInsights('leales')">
                <i class='bx bxs-magic-wand'></i> Generar Insights con IA
            </button>
        </div>

        <!-- Hibernando -->
        <div class="segment-card" style="border-left: 4px solid var(--warning);">
            <div class="segment-header">
                <h4>üò¥ Hibernando</h4>
                <span class="segment-badge" id="hibernando-usuarios">- usuarios</span>
            </div>
            <p>Ocasionales con bajo engagement. Oportunidad de reactivaci√≥n.</p>
            <div class="segment-stats u-grid-1-1 u-mt-1">
                <span><i class='bx bx-chart-line'></i> Engagement: <strong id="hibernando-engagement">-</strong>%</span>
                <span><i class='bx bx-refresh'></i> Recuperaci√≥n: <strong id="hibernando-potencial">-</strong></span>
            </div>
            <button class="btn btn-secondary u-full-width u-mt-1" onclick="generateAIInsights('hibernando')">
                <i class='bx bxs-magic-wand'></i> Generar Insights con IA
            </button>
        </div>

        <!-- Perdidos -->
        <div class="segment-card" style="border-left: 4px solid var(--secondary);">
            <div class="segment-header">
                <h4>üí§ Perdidos</h4>
                <span class="segment-badge" id="perdidos-usuarios">- usuarios</span>
            </div>
            <p>Inactivos con engagement muy bajo. Dif√≠cil recuperaci√≥n.</p>
            <div class="segment-stats u-grid-1-1 u-mt-1">
                <span><i class='bx bx-error-circle'></i> Engagement: <strong id="perdidos-engagement">-</strong>%</span>
                <span><i class='bx bx-dollar'></i> Valor Perdido: <strong id="perdidos-valor">-</strong></span>
            </div>
            <button class="btn btn-secondary u-full-width u-mt-1" onclick="generateAIInsights('perdidos')">
                <i class='bx bxs-magic-wand'></i> Generar Insights con IA
            </button>
        </div>
    </div>

    <!-- AI Insights Panel (Modal) -->
    <div id="aiInsightsModal" class="modal u-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class='bx bxs-brain'></i> Insights de IA - <span id="modalSegmentName"></span></h3>
                <button class="modal-close" onclick="closeAIModal()">&times;</button>
            </div>
            <div class="modal-body" id="aiInsightsContent">
                <div class="u-text-center u-p-2">
                    <i class='bx bx-loader bx-spin' style='font-size: 48px; color: var(--primary);'></i>
                    <p class="u-muted u-mt-1">Generando insights con ChatGPT...</p>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.segments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.5rem;
}

.segment-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.segment-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.segment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.segment-header h4 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--text-primary);
}

.segment-badge {
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
}

.segment-badge.warning {
    background: var(--danger);
}

.segment-badge.success {
    background: var(--success);
}

.segment-stats {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.segment-stats i {
    margin-right: 0.25rem;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 16px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-secondary);
    padding: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--hover-bg);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
}

.ai-persona-card, .ai-recommendations-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.ai-persona-card h4, .ai-recommendations-card h4 {
    margin-top: 0;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.ai-recommendation-item {
    background: white;
    border-left: 4px solid var(--primary);
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
}

.ai-recommendation-item:last-child {
    margin-bottom: 0;
}

.ai-tag {
    display: inline-block;
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-right: 0.5rem;
    margin-top: 0.5rem;
}
</style>